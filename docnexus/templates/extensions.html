<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extensions | DocNexus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='settings_menu.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='extensions.css') }}">
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script>
        // Init theme immediately to prevent FOUC
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>

<body>
    <header>
        <a href="/" class="brand" title="Back to Workspace">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="DocNexus Logo" class="brand-logo"
                onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“„</text></svg>'">
            <div>
                <span class="brand-text">DocNexus</span>
                <span class="brand-version"
                    style="background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: rgba(16, 185, 129, 0.2);">Extensions</span>
            </div>
        </a>
        <div class="nav-controls">
            <!-- Global "Extensions" Search (Moved from body) -->
            <div class="search-bar" style="width: 280px;">
                <i class="fas fa-search"></i>
                <input type="text" id="extensionSearch" name="query" placeholder="Search extensions...">
            </div>

            <!-- Refresh Button -->
            <button class="btn-icon" id="btn-refresh-registry" title="Refresh Registry">
                <i class="fas fa-sync-alt"></i>
            </button>
            {% include 'components/settings_menu.html' %}
        </div>
    </header>

    <main class="extensions-container">

        <!-- Premium Header Area -->
        <div class="extensions-header">
            <div class="header-title">
                <h2>Marketplace</h2>
                <p>Discover extensions to supercharge your documentation workflow.</p>
            </div>

            <div class="marketplace-controls">
                <!-- Search moved to header -->
            </div>
        </div>

        <!-- Filters -->
        <div style="display:flex; gap:12px; margin-bottom: 32px; overflow-x: auto; padding-bottom: 4px;">
            <button class="filter-btn active" onclick="filterPlugins(this, 'all')">All</button>
            <button class="filter-btn" onclick="filterPlugins(this, 'installed')">Installed</button>
            <div style="width:1px; background:var(--color-border-muted); margin:0 8px;"></div>
            <button class="filter-btn" onclick="filterPlugins(this, 'editor')">Editors</button>
            <button class="filter-btn" onclick="filterPlugins(this, 'export')">Export</button>
            <button class="filter-btn" onclick="filterPlugins(this, 'theme')">Themes</button>
            <button class="filter-btn" onclick="filterPlugins(this, 'tool')">Tools</button>
        </div>

        <div class="extensions-grid" id="pluginGrid">
            <!-- Loading State -->
            <div style="grid-column: 1/-1; text-align: center; padding: 4rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--color-accent-primary);"></i>
                <p style="margin-top: 1rem; color: var(--color-text-muted);">Loading Registry...</p>
            </div>
        </div>
    </main>


    <!-- Uninstall Confirmation Modal (Structure now matches updated theme.css) -->
    <div id="uninstall-modal" class="modal-overlay">
        <div class="modal-card" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="color:var(--color-danger);"><i class="fas fa-exclamation-triangle"></i> Disable Extension?
                </h3>
                <button class="btn-icon" style="width:32px;height:32px;" onclick="closeUninstallModal()">
                    <i class="fas fa-times" style="font-size:0.9rem;"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to disable <strong><span id="uninstall-name">this extension</span></strong>?
                </p>
                <div
                    style="background:var(--color-bg-secondary); padding:12px; border-radius:8px; margin-top:12px; font-size:0.9rem; border:1px solid var(--color-border-muted);">
                    <i class="fas fa-info-circle" style="color:var(--color-text-muted);"></i> Features relying on this
                    extension will stop working immediately.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeUninstallModal()">Cancel</button>
                <button id="confirm-uninstall-btn" class="btn"
                    style="background:var(--color-danger); color:white; border:none; box-shadow:var(--shadow-md);">
                    <i class="fas fa-power-off"></i> Disable
                </button>
            </div>
        </div>
    </div>

    <!-- Error Handler & Debug Probe (SAFE BLOCK) -->
    <style>
        /* Professional Standard Modal Styles */
        #manage-modal .modal {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border-muted);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            /* Cleaner shadow */
            border-radius: 8px;
            /* Standard radius */
            color: var(--color-text-primary);
            max-width: 500px;
            width: 90%;
            padding: 0;
            overflow: hidden;
            animation: modalFadeIn 0.15s ease-out;
            /* Faster anim */
        }

        #manage-modal .modal-header {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border-muted);
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #manage-modal .modal-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        #manage-modal .close-btn {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            transition: color 0.1s;
        }

        #manage-modal .close-btn:hover {
            color: var(--color-danger);
        }

        .extension-detail-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            border-bottom: 1px solid var(--color-border-muted);
            background: var(--color-bg-primary);
        }

        .extension-icon-large {
            width: 64px;
            height: 64px;
            background: var(--color-bg-secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--color-accent-primary);
            border: 1px solid var(--color-border-muted);
        }

        .extension-detail-header h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1.25rem;
            color: var(--color-text-primary);
        }

        /* Distinctive Category Pill */
        /* Distinctive Category Pill (Professional Theme) */
        .category-pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
            /* User requested "not all CAPS" */
            letter-spacing: normal;
            background: var(--color-bg-secondary);
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-primary);
            opacity: 0.9;
        }

        /* Dynamic Pill Colors (Attribute selector usage in JS would be better, but assuming classes) */
        /* Since we don't have classes on pills yet, we use CSS nth-child or style injection. 
           User asked to make it standard. 
           We will style the specific 'manage-type' badge here too */
        #manage-type {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .settings-group {
            padding: 1.5rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--color-border-muted);
            background: var(--color-bg-secondary);
        }

        .setting-label .setting-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }

        .setting-label .setting-desc {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .toggle-control {
            display: flex;
            background: var(--color-bg-primary);
            border-radius: 6px;
            padding: 2px;
            border: 1px solid var(--color-border-muted);
        }

        .toggle-option {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--color-text-muted);
            transition: all 0.1s;
        }

        .toggle-option.active {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            font-weight: 600;
            border: 1px solid var(--color-border-muted);
            /* Distinct active state */
        }

        #manage-modal .modal-actions {
            padding: 1rem 1.5rem;
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border-muted);
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* --- Premium Toast Styles (Themed) --- */
        .toast-item {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-default);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            font-family: var(--font-body);
            min-width: 320px;
            overflow: hidden;
            position: relative;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
        }

        .toast-item.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-msg {
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.3px;
            color: var(--color-text-primary);
        }

        .toast-progress {
            height: 3px;
            width: 0%;
            position: absolute;
            bottom: 0;
            left: 0;
            transition: width 3.5s linear;
        }

        .toast-item.show .toast-progress {
            width: 100%;
        }

        /* Variants (Themed) */
        .toast-success .toast-icon {
            color: var(--color-success);
        }

        .toast-success .toast-progress {
            background-color: var(--color-success);
        }

        .toast-error .toast-icon {
            color: var(--color-danger);
        }

        .toast-error .toast-progress {
            background-color: var(--color-danger);
        }

        .toast-uninstall .toast-icon {
            color: var(--color-danger);
        }

        .toast-uninstall .toast-progress {
            background-color: var(--color-danger);
        }

        .toast-info .toast-icon {
            color: var(--color-accent-primary);
        }

        .toast-info .toast-progress {
            background-color: var(--color-accent-primary);
        }
    </style>
    <script>
        // Definition in a separate block ensures it runs even if main block fails parsing
        window.onerror = function (msg, url, line, col, error) {
            const errorMsg = `JS Error: ${msg}\nLine: ${line}:${col}`;
            alert(errorMsg); // Immediate Feedback

            // Also try to write to grid if it exists
            setTimeout(() => {
                const grid = document.getElementById('pluginGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #ef4444; background: #fee2e2; border-radius: 8px; border: 2px solid red;">
                            <i class="fas fa-bug" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <h3>Client-Side Script Error</h3>
                            <pre style="text-align: left; background: rgba(0,0,0,0.05); padding: 1rem; overflow: auto; margin-top: 1rem;">${errorMsg}</pre>
                        </div>
                    `;
                }
            }, 100);
            return false;
        };

        // Confirm this block runs
        console.log("DEBUG: Error Handler Installed");
        // alert("DEBUG: Error Handler Installed (Safe Block)"); 
    </script>

    <!-- Main Logic -->
    <script>
        // Visual Logger (Stubbed for Production)
        function logVisual(msg) {
            console.log(msg);
        }

        // --- Core Functions ---

        console.log("Extensions page loaded.");

        // Store fetched plugins
        let allPlugins = [];

        // Uninstall Modal State
        let pendingUninstallId = null;
        let pendingUninstallBtn = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Search Logic
            const searchInput = document.getElementById('extensionSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = allPlugins.filter(p =>
                        (p.name && p.name.toLowerCase().includes(term)) ||
                        (p.description && p.description.toLowerCase().includes(term)) ||
                        (p.desc && p.desc.toLowerCase().includes(term))
                    );
                    renderPlugins(filtered);

                    // Reset filters UI if searching
                    if (term.length > 0) {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    } else {
                        // Default to 'All' if cleared
                        document.querySelector('.filter-btn').classList.add('active');
                    }
                });
            }

            // Init load
            setTimeout(fetchRegistry, 300);
        });

        // --- Core Functions ---

        async function fetchRegistry() {
            logVisual("fetchRegistry: Start");
            const grid = document.getElementById('pluginGrid');

            try {
                logVisual("fetchRegistry: Fetching /api/plugins...");
                // Cache busting to ensure fresh installed status
                const response = await fetch(`/api/plugins?t=${Date.now()}`, { cache: 'no-store' });
                logVisual(`fetchRegistry: Got response ${response.status}`);

                if (!response.ok) {
                    logVisual(`fetchRegistry: Error ${response.status}`);
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                logVisual(`fetchRegistry: Parsed JSON. Items: ${data.length}`);

                // Use global allPlugins
                allPlugins = data;
                renderPlugins(allPlugins);
                logVisual(`fetchRegistry: Rendered.`);
            } catch (e) {
                logVisual("fetchRegistry ERROR: " + e.message);
                console.error('Registry Error:', e);

                if (grid) {
                    grid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; color: var(--color-danger);">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                                <p>Failed to load registry: ${e.message}</p>
                                <button onclick="fetchRegistry()" class="btn">Retry</button>
                            </div>
                        `;
                }
            }
        }
        function filterPlugins(btn, category) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (category === 'all') {
                renderPlugins(allPlugins);
            } else if (category === 'installed') {
                // Show all installed (Bundled + User)
                renderPlugins(allPlugins.filter(p => p.installed));
            } else {
                renderPlugins(allPlugins.filter(p => p.category === category));
            }
        }

        function renderPlugins(plugins) {
            const grid = document.getElementById('pluginGrid');

            if (!plugins || plugins.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 4rem; opacity: 0.7;">
                        <i class="fas fa-box-open" style="font-size: 2rem; color: var(--color-text-muted);"></i>
                        <p style="margin-top: 1rem; color: var(--color-text-muted);">No extensions found.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = plugins.map(p => `
            <div class="extension-card">
                <div class="card-header">
                    <div class="extension-icon">
                        ${p.icon && p.icon.startsWith('/') ? `<img src="${p.icon}" style="width:24px;height:24px;">` : `<i class="fas ${p.icon || 'fa-cube'}"></i>`}
                    </div>
                    <div class="card-title-area">
                        <div class="extension-title">
                            ${p.name}
                            ${p.type === 'bundled' ? '<i class="fas fa-certificate verified-badge" title="Official"></i>' : ''}
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <a href="#" class="author-link">${p.author || 'DocNexus'}</a>
                            <span class="category-pill">${p.category}</span>
                            ${p.is_priority ? '<i class="fas fa-star" title="High Priority" style="color:#fbbf24; font-size:0.75rem;"></i>' : ''}
                            ${p.id === 'pdf_export' ? console.log('Frontend Render: pdf_export installed=', p.installed) || '' : ''}
                        </div>
                    </div>
                </div>

                <div class="extension-desc" title="${p.description || ''}">${p.description || p.desc || 'No description'}</div>

                <div class="card-stats">
                    <span class="stat-item"><i class="fas fa-download"></i> ${p.downloads || '-'}</span>
                    <span class="stat-item">${p.installed ? '<i class="fas fa-check-circle" style="color:var(--color-success)"></i> Installed' : '<i class="far fa-circle"></i> Available'}</span>
                </div>

                <div class="extension-actions">
                    ${renderActionButton(p)}
                </div>
            </div>
            `).join('');
        }

        function renderActionButton(p) {
            if (!p.installed && p.can_install) {
                return `<button class="btn-manage" style="background:#10b981; color:white; border:none;" onclick="installPlugin('${p.id}', this)">
                <i class="fas fa-download"></i> Install
            </button>`;
            }
            if (p.installed && p.can_install) {
                // Installable plugins can be uninstalled directly
                return `<button class="btn-manage" style="background:var(--color-danger); color:white; border:none;" onclick="triggerUninstall('${p.id}', this)">
                <i class="fas fa-trash-alt"></i> Uninstall
            </button>`;
            }
            // If installed (bundled/preinstalled), allow Manage (Priority settings)
            return `<button class="btn-manage" onclick="openManageModal('${p.id}')">
                <i class="fas fa-cog"></i> Manage
            </button>`;
        }

        // --- Action Handlers ---

        async function installPlugin(id, btn) {
            logVisual(`Start Install: ${id}`);
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Installing...';

            try {
                logVisual(`Fetching /api/plugins/install/${id}`);
                const res = await fetch(`/api/plugins/install/${id}`, { method: 'POST' });
                logVisual(`Response: ${res.status}`);

                const json = await res.json();
                console.log("Frontend: Response JSON:", json);

                if (res.ok) {
                    logVisual("Install OK. Setup...");

                    // Use Safe Toast with Friendly Name
                    const plugin = allPlugins.find(p => p.id === id);
                    const pluginName = plugin ? plugin.name : id;
                    safeShowToast(`Installed <b>${pluginName}</b> successfully.`, "success");

                    // Fallback
                    logVisual("Scheduling fallback timer...");
                    const fallbackTimer = setTimeout(() => {
                        logVisual("FALLBACK TIMER FIRED.");
                        if (btn.disabled) {
                            logVisual("Button disabled -> Forcing Reload via HREF assigned");
                            window.location.href = window.location.href;
                        } else {
                            logVisual("Button enabled -> No reload needed.");
                        }
                    }, 2000);

                    // Attempt live update
                    logVisual("Calling fetchRegistry()...");
                    await fetchRegistry();

                    // If we get here, fetch finished. Use clearTimeout if you trust it.
                    logVisual("fetchRegistry returned. Clearing fallback.");
                    clearTimeout(fallbackTimer);
                } else {
                    logVisual(`Frontend: Error ${json.error}`);
                    safeShowToast("Error: " + json.error, "error");
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            } catch (e) {
                console.error("Frontend: Network/Logic Exception:", e);
                logVisual("Exception: " + e.message);
                safeShowToast("Network Error: " + e.message, "error");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // Renamed to avoid any strict mode / scope conflicts
        // --- Robust Toast ---
        // --- Robust Toast (Theme Integrated) ---
        function safeShowToast(msg, type = 'info') {
            // Ensure Container
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed; bottom:30px; right:30px; z-index:999999; display:flex; flex-direction:column; gap:12px; pointer-events:none;';
                document.body.appendChild(container);
            }

            // Create Toast
            const toast = document.createElement('div');
            toast.className = `toast-item toast-${type}`;

            // Icon Map (Inline SVG for offline reliability)
            const icons = {
                'success': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,

                'error': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,

                'uninstall': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,

                'info': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
            };
            const iconSvg = icons[type] || icons['info'];

            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon" style="display:flex">${iconSvg}</div>
                    <span class="toast-msg">${msg}</span>
                </div>
                <div class="toast-progress"></div>
            `;

            // Append
            container.appendChild(toast);

            // Animate
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3500);
        }

        // Renamed to avoid any strict mode / scope conflicts
        function triggerUninstall(id, btn) {
            // Confirmation Removed per User Request

            logVisual(`Start Uninstall: ${id}`);
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uninstalling...';

            // Get Friendly Name for Toast
            const plugin = allPlugins.find(p => p.id === id);
            const pluginName = plugin ? plugin.name : id;

            // Safety Timer
            const fallbackTimer = setTimeout(() => {
                logVisual("Uninstall FALLBACK TIMER fired. Reloading.");
                window.location.href = window.location.href;
            }, 3000);

            fetch(`/api/plugins/uninstall/${id}`, { method: 'POST' })
                .then(res => res.json().then(data => ({ status: res.status, ok: res.ok, data })))
                .then(({ ok, data }) => {
                    if (ok) {
                        logVisual("Uninstall OK.");
                        try { safeShowToast(`Uninstalled <b>${pluginName}</b>`, "uninstall"); } catch (e) { }

                        logVisual("Refreshing registry...");
                        fetchRegistry().then(() => {
                            clearTimeout(fallbackTimer);
                        });
                    } else {
                        logVisual(`Uninstall Failed: ${data.error}`);
                        try { safeShowToast(`Error: ${data.error}`, "error"); } catch (e) { }
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                        clearTimeout(fallbackTimer);
                    }
                })
                .catch(err => {
                    logVisual(`Uninstall Network Error: ${err.message}`);
                    try { safeShowToast("Network Error: " + err.message, "error"); } catch (e) { }
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                    clearTimeout(fallbackTimer);
                });
        }

        function closeUninstallModal() {
            document.getElementById('uninstall-modal').classList.remove('show');
            pendingUninstallId = null;
            pendingUninstallBtn = null;
        }

        // --- Manage Modal Logic ---
        let currentManageId = null;

        function openManageModal(id) {
            currentManageId = id;
            const p = allPlugins.find(plug => plug.id === id);
            if (!p) return;

            document.getElementById('manage-name').textContent = p.name;
            document.getElementById('manage-type').textContent = p.type.toUpperCase() + ' â€¢ ' + p.category.toUpperCase();

            const iconContainer = document.getElementById('manage-icon');
            iconContainer.innerHTML = p.icon && p.icon.startsWith('/') ? `<img src="${p.icon}" style="width:32px;">` : `<i class="fas ${p.icon || 'fa-cube'}"></i>`;

            // Setup Priority Toggle
            const toggle = document.getElementById('priorityToggle');
            const isPriority = p.is_priority;

            toggle.setAttribute('data-value', isPriority ? 'high' : 'normal');
            toggle.querySelector('[data-value="normal"]').className = `toggle-option ${!isPriority ? 'active' : ''}`;
            toggle.querySelector('[data-value="high"]').className = `toggle-option ${isPriority ? 'active' : ''}`;

            // Setup Disable Button
            const disableBtn = document.getElementById('manage-disable-btn');
            if (p.can_install && p.installed) {
                disableBtn.style.display = 'block';
                disableBtn.onclick = () => {
                    closeManageModal();
                    triggerUninstall(id, null);
                };
            } else {
                disableBtn.style.display = 'none';
            }

            // Click listener for toggle
            toggle.onclick = (e) => {
                const target = e.target.closest('.toggle-option');
                if (!target) return;
                const val = target.getAttribute('data-value');
                toggle.setAttribute('data-value', val);
                toggle.querySelectorAll('.toggle-option').forEach(opt => opt.classList.remove('active'));
                target.classList.add('active');
            };

            document.getElementById('manage-modal').classList.add('show');
        }

        function closeManageModal() {
            document.getElementById('manage-modal').classList.remove('show');
            currentManageId = null;
        }

        async function savePriority() {
            if (!currentManageId) return;

            const toggle = document.getElementById('priorityToggle');
            const isHigh = toggle.getAttribute('data-value') === 'high';

            // Build Priority List
            let priorityList = allPlugins.filter(p => p.is_priority).map(p => p.id);

            if (isHigh) {
                if (!priorityList.includes(currentManageId)) priorityList.push(currentManageId);
            } else {
                priorityList = priorityList.filter(id => id !== currentManageId);
            }

            try {
                const res = await fetch('/api/plugins/priority', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priority: priorityList })
                });

                if (res.ok) {
                    showToast('Settings saved successfully', 'success');
                    closeManageModal();
                    fetchRegistry(); // Refresh list to update UI badges
                } else {
                    showToast('Failed to save settings', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }


        async function performUninstall() {
            if (!pendingUninstallId) return;

            const id = pendingUninstallId;
            const btn = pendingUninstallBtn;
            closeUninstallModal();

            if (btn) {
                var originalContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Disabling...';
            }

            try {
                const res = await fetch(`/api/plugins/uninstall/${id}`, { method: 'POST' });
                const json = await res.json();
                if (res.ok) {
                    showToast("Extension disabled.", "info");
                    fetchRegistry();
                } else {
                    showToast("Error: " + json.error, "error");
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                }
            } catch (e) {
                showToast("Error: " + e, "error");
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
        }

        function togglePlugin(id) {
            showToast('Core extensions cannot be modified.', 'info');
        }

        // --- Toast Logic ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' :
                (type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>');

            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6'
            };
            const color = colors[type] || colors.info;

            toast.style.cssText = `
                display: flex;
                align-items: center;
                gap: 12px;
                background: var(--color-bg-primary);
                color: var(--color-text-primary);
                border-left: 4px solid ${color};
                padding: 16px;
                border-radius: 4px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                min-width: 320px;
                opacity: 0;
                transform: translateX(20px);
                transition: all 0.3s ease;
                font-family: inherit;
                font-size: 0.95rem;
                z-index: 3001;
                `;

            toast.innerHTML = `
                <div style="color: ${color}; font-size: 1.25rem;">${icon}</div>
                <div style="font-weight:500;">${message}</div>
            `;

            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            });
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // --- Settings Menu Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const settingsTrigger = document.querySelector('.settings-trigger');
            const settingsMenu = document.getElementById('settingsMenu');
            const refreshBtn = document.getElementById('btn-refresh-registry');

            // 1. Refresh Handler
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    // Spin only the icon, not the button container
                    const icon = refreshBtn.querySelector('i');
                    if (icon) icon.classList.add('fa-spin');

                    showToast('Refreshing registry...', 'info');

                    await fetchRegistry();

                    setTimeout(() => {
                        if (icon) icon.classList.remove('fa-spin');
                        // Also ensure button doesn't have it if it was added mistakenly
                        refreshBtn.classList.remove('fa-spin');
                        showToast('Registry updated', 'success');
                    }, 500);
                });
            }


        });
    </script>
    <!-- Manage Modal -->
    <div id="manage-modal" class="modal-overlay" onclick="if(event.target === this) closeManageModal()">
        <div class="modal">
            <div class="modal-header">
                <h2>Manage Extension</h2>
                <button class="close-btn" onclick="closeManageModal()">&times;</button>
            </div>

            <div class="extension-detail-header">
                <div class="extension-icon-large" id="manage-icon"></div>
                <div>
                    <h3 id="manage-name">Extension Name</h3>
                    <div class="badge badge-gray" id="manage-type">TYPE â€¢ CATEGORY</div>
                </div>
            </div>

            <div class="settings-group">
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Priority Load</div>
                        <div class="setting-desc">Load this extension before others to override capabilities.</div>
                    </div>
                    <div class="toggle-control" id="priorityToggle" data-value="normal">
                        <div class="toggle-option active" data-value="normal">Normal</div>
                        <div class="toggle-option" data-value="high">High</div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-danger" id="manage-disable-btn">Disable Extension</button>
                <div style="flex:1"></div>
                <button class="btn btn-secondary" onclick="closeManageModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePriority()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Uninstall Confirmation Modal -->
    <div id="uninstall-modal" class="modal-overlay" onclick="if(event.target === this) closeUninstallModal()">
        <div class="modal">
            <div class="modal-header">
                <h2>Uninstall Extension</h2>
                <button class="close-btn" onclick="closeUninstallModal()">&times;</button>
            </div>
            <div style="padding: 2rem 0; text-align: center; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem; color: #ef4444;"><i class="fas fa-trash-alt"></i>
                </div>
                <p>Are you sure you want to uninstall <strong id="uninstall-name" style="color:var(--text-primary)">this
                        extension</strong>?</p>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">This action cannot be undone efficiently without
                    reinstalling.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUninstallModal()">Cancel</button>
                <button class="btn btn-danger" id="confirm-uninstall-btn">Uninstall</button>
            </div>
        </div>
    </div>
</body>

</html>